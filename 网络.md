# 网络

## 一、TCP

- #### tcp的状态

  1、LISTENING状态
  　　FTP服务启动后首先处于侦听（LISTENING）状态。

  2、ESTABLISHED状态
  　　ESTABLISHED的意思是建立连接。表示两台机器正在通信。

  3、CLOSE_WAIT

      对方主动关闭连接或者网络异常导致连接中断，这时我方的状态会变成CLOSE_WAIT 此时我方要调用close()来使得连接正确关闭

  4、TIME_WAIT

  ```txt
  我方主动调用close()断开连接，收到对方确认后状态变为TIME_WAIT。TCP协议规定TIME_WAIT状态会一直持续2MSL(即两倍的分段最大生存期)，以此来确保旧的连接状态不会对新连接产生影响。处于TIME_WAIT状态的连接占用的资源不会被内核释放，所以作为服务器，在可能的情况下，尽量不要主动断开连接，以减少TIME_WAIT状态造成的资源浪费。
  
  目前有一种避免TIME_WAIT资源浪费的方法，就是关闭socket的LINGER选项。但这种做法是TCP协议不推荐使用的，在某些情况下这个操作可能会带来错误。
  ```

- #### 三次握手

  建立起一个TCP连接需要经过“三次握手”：

     第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；

     第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；

     第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

  握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连 接之前，TCP 连接都将被一直保持下去。断开连接时服务器和客户端均可以主动发起断开TCP连接的请求，断开过程需要经过“四次握手”（过程就不细写 了，就是服务器和客户端交互，最终确定断开）

   如果不第一次握 那就没法建立连接

  如果没有第二次握手 也就是不需要服务端返回ACK响应，那么客户端以往服务端没有收到 就会重新请求，服务端又会重新申请资源去连接

  如果没有第三次握手 也就是客户端没有确认这个ACK响应，服务端会等待这个AC响应，如果这个响应迟迟没有来，就会认为这个SYN是无效的，就会释放相关资源

- #### 常见协议

  > 三种协议实际上对应包封装的过程

  - 以太网协议
  - ip协议
  - tcp协议

  